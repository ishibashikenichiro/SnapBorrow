<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Socket::AncillaryData
  
    &mdash; Documentation by YARD 0.8.7.4
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../';
  framesUrl = "../frames.html#!Socket/AncillaryData.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (A)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Socket.html" title="Socket (class)">Socket</a></span></span>
     &raquo; 
    <span class="title">AncillaryData</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Socket::AncillaryData
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></span>
      
        <ul class="fullTree">
          <li><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></li>
          
            <li class="next">Socket::AncillaryData</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">ext/socket/ancdata.c<span class="defines">,<br />
  ext/socket/ancdata.c</span>
</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Socket::AncillaryData represents the ancillary data (control information)
used by sendmsg and recvmsg system call.  It contains socket #family,
control message (cmsg) #level, cmsg #type and cmsg #data.</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#int-class_method" title="Socket::AncillaryData.int (class method)">+ (Object) <strong>Socket::AncillaryData.int</strong>(family, cmsg_level, cmsg_type, integer) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Creates a new Socket::AncillaryData object which contains a int as data.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#ip_pktinfo-class_method" title="ip_pktinfo (class method)">+ (Object) <strong>ip_pktinfo</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns new ancillary data for IP_PKTINFO.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#ipv6_pktinfo-class_method" title="Socket::AncillaryData.ipv6_pktinfo (class method)">+ (Object) <strong>Socket::AncillaryData.ipv6_pktinfo</strong>(addr, ifindex) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns new ancillary data for IPV6_PKTINFO.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unix_rights-class_method" title="Socket::AncillaryData.unix_rights (class method)">+ (Object) <strong>Socket::AncillaryData.unix_rights</strong>(io1, io2, ...) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Creates a new Socket::AncillaryData object which contains file descriptors
as data.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cmsg_is%3F-instance_method" title="#cmsg_is? (instance method)">- (Boolean) <strong>cmsg_is?</strong>(level, type) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>tests the level and type of <em>ancillarydata</em>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#data-instance_method" title="#data (instance method)">- (String) <strong>data</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>returns the cmsg data as a string.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#family-instance_method" title="#family (instance method)">- (Integer) <strong>family</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>returns the socket family as an integer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#Socket::AncillaryData.new (instance method)">- (Object) <strong>Socket::AncillaryData.new</strong>(family, cmsg_level, cmsg_type, cmsg_data) </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p><em>family</em> should be an integer, a string or a symbol.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#inspect-instance_method" title="#inspect (instance method)">- (String) <strong>inspect</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>returns a string which shows ancillarydata in human-readable form.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#int-instance_method" title="#int (instance method)">- (Integer) <strong>int</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the data in <em>ancillarydata</em> as an int.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#ip_pktinfo-instance_method" title="#ip_pktinfo (instance method)">- (Array) <strong>ip_pktinfo</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Extracts addr, ifindex and spec_dst from IP_PKTINFO ancillary data.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#ipv6_pktinfo-instance_method" title="#ipv6_pktinfo (instance method)">- (Array) <strong>ipv6_pktinfo</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Extracts addr and ifindex from IPV6_PKTINFO ancillary data.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#ipv6_pktinfo_addr-instance_method" title="#ipv6_pktinfo_addr (instance method)">- (Object) <strong>ipv6_pktinfo_addr</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Extracts addr from IPV6_PKTINFO ancillary data.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#ipv6_pktinfo_ifindex-instance_method" title="#ipv6_pktinfo_ifindex (instance method)">- (Object) <strong>ipv6_pktinfo_ifindex</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Extracts ifindex from IPV6_PKTINFO ancillary data.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#level-instance_method" title="#level (instance method)">- (Integer) <strong>level</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>returns the cmsg level as an integer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#timestamp-instance_method" title="#timestamp (instance method)">- (Time) <strong>timestamp</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>returns the timestamp as a time object.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#type-instance_method" title="#type (instance method)">- (Integer) <strong>type</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>returns the cmsg type as an integer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unix_rights-instance_method" title="#unix_rights (instance method)">- (array-of-IOs<sup>?</sup>) <strong>unix_rights</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>returns the array of IO objects for SCM_RIGHTS control message in UNIX
domain socket.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>Socket::AncillaryData.new</strong>(family, cmsg_level, cmsg_type, cmsg_data) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p><em>family</em> should be an integer, a string or a symbol.</p>
<ul><li>
<p>Socket::AF_INET, “AF_INET”, “INET”, :AF_INET, :INET</p>
</li><li>
<p>Socket::AF_UNIX, “AF_UNIX”, “UNIX”, :AF_UNIX, :UNIX</p>
</li><li>
<p>etc.</p>
</li></ul>

<p><em>cmsg_level</em> should be an integer, a string or a symbol.</p>
<ul><li>
<p>Socket::SOL_SOCKET, “SOL_SOCKET”, “SOCKET”, :SOL_SOCKET and :SOCKET</p>
</li><li>
<p>Socket::IPPROTO_IP, “IP” and :IP</p>
</li><li>
<p>Socket::IPPROTO_IPV6, “IPV6” and :IPV6</p>
</li><li>
<p>Socket::IPPROTO_TCP, “TCP” and :TCP</p>
</li><li>
<p>etc.</p>
</li></ul>

<p><em>cmsg_type</em> should be an integer, a string or a symbol. If a
string/symbol is specified, it is interpreted depend on
<em>cmsg_level</em>.</p>
<ul><li>
<p>Socket::SCM_RIGHTS, “SCM_RIGHTS”, “RIGHTS”, :SCM_RIGHTS, :RIGHTS for
SOL_SOCKET</p>
</li><li>
<p>Socket::IP_RECVTTL, “RECVTTL” and :RECVTTL for IPPROTO_IP</p>
</li><li>
<p>Socket::IPV6_PKTINFO, “PKTINFO” and :PKTINFO for IPPROTO_IPV6</p>
</li><li>
<p>etc.</p>
</li></ul>

<p><em>cmsg_data</em> should be a string.</p>

<pre class="ruby"><span class="ruby-identifier">p</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">new</span>(:<span class="ruby-constant">INET</span>, :<span class="ruby-constant">TCP</span>, :<span class="ruby-constant">NODELAY</span>, <span class="ruby-string">&quot;&quot;</span>)
<span class="ruby-comment">#=&gt; #&lt;Socket::AncillaryData: INET TCP NODELAY &quot;&quot;&gt;</span>

<span class="ruby-identifier">p</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">new</span>(:<span class="ruby-constant">INET6</span>, :<span class="ruby-constant">IPV6</span>, :<span class="ruby-constant">PKTINFO</span>, <span class="ruby-string">&quot;&quot;</span>)
<span class="ruby-comment">#=&gt; #&lt;Socket::AncillaryData: INET6 IPV6 PKTINFO &quot;&quot;&gt;</span>
</pre>


  </div>
</div>
<div class="tags">
  
  


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


72
73
74
75
76
77
78
79
80
81
82
83
84</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 72</span>

static VALUE
ancillary_initialize(VALUE self, VALUE vfamily, VALUE vlevel, VALUE vtype, VALUE data)
{
    int family = rsock_family_arg(vfamily);
    int level = rsock_level_arg(family, vlevel);
    int type = rsock_cmsg_type_arg(family, level, vtype);
    StringValue(data);
    rb_ivar_set(self, rb_intern(&quot;family&quot;), INT2NUM(family));
    rb_ivar_set(self, rb_intern(&quot;level&quot;), INT2NUM(level));
    rb_ivar_set(self, rb_intern(&quot;type&quot;), INT2NUM(type));
    rb_ivar_set(self, rb_intern(&quot;data&quot;), data);
    return self;
}</pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="int-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>Socket::AncillaryData.int</strong>(family, cmsg_level, cmsg_type, integer) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Creates a new Socket::AncillaryData object which contains a int as data.</p>

<p>The size and endian is dependent on the host.</p>

<pre class="ruby"><span class="ruby-identifier">p</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">int</span>(:<span class="ruby-constant">UNIX</span>, :<span class="ruby-constant">SOCKET</span>, :<span class="ruby-constant">RIGHTS</span>, <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">fileno</span>)
<span class="ruby-comment">#=&gt; #&lt;Socket::AncillaryData: UNIX SOCKET RIGHTS 2&gt;</span>
</pre>


  </div>
</div>
<div class="tags">
  
  


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


364
365
366
367
368
369
370
371
372</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 364</span>

static VALUE
ancillary_s_int(VALUE klass, VALUE vfamily, VALUE vlevel, VALUE vtype, VALUE integer)
{
    int family = rsock_family_arg(vfamily);
    int level = rsock_level_arg(family, vlevel);
    int type = rsock_cmsg_type_arg(family, level, vtype);
    int i = NUM2INT(integer);
    return ancdata_new(family, level, type, rb_str_new((char*)&amp;i, sizeof(i)));
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="ip_pktinfo-class_method">
  
    
      <span class="overload">+ (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>Socket::AncillaryData.ip_pktinfo</strong>(addr, ifindex) </span>
    
      <span class="overload">+ (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>Socket::AncillaryData.ip_pktinfo</strong>(addr, ifindex, spec_dst) </span>
    
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns new ancillary data for IP_PKTINFO.</p>

<p>If spec_dst is not given, addr is used.</p>

<p>IP_PKTINFO is not standard.</p>

<p>Supported platform: GNU/Linux</p>

<pre class="ruby"><span class="ruby-identifier">addr</span> = <span class="ruby-constant">Addrinfo</span>.<span class="ruby-identifier">ip</span>(<span class="ruby-string">&quot;127.0.0.1&quot;</span>)
<span class="ruby-identifier">ifindex</span> = <span class="ruby-value">0</span>
<span class="ruby-identifier">spec_dst</span> = <span class="ruby-constant">Addrinfo</span>.<span class="ruby-identifier">ip</span>(<span class="ruby-string">&quot;127.0.0.1&quot;</span>)
<span class="ruby-identifier">p</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">ip_pktinfo</span>(<span class="ruby-identifier">addr</span>, <span class="ruby-identifier">ifindex</span>, <span class="ruby-identifier">spec_dst</span>)
<span class="ruby-comment">#=&gt; #&lt;Socket::AncillaryData: INET IP PKTINFO 127.0.0.1 ifindex:0 spec_dst:127.0.0.1&gt;</span>
</pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 418</span>

static VALUE
ancillary_s_ip_pktinfo(int argc, VALUE *argv, VALUE self)
{
    VALUE v_addr, v_ifindex, v_spec_dst;
    unsigned int ifindex;
    struct sockaddr_in sa;
    struct in_pktinfo pktinfo;

    rb_scan_args(argc, argv, &quot;21&quot;, &amp;v_addr, &amp;v_ifindex, &amp;v_spec_dst);

    SockAddrStringValue(v_addr);
    ifindex = NUM2UINT(v_ifindex);
    if (NIL_P(v_spec_dst))
        v_spec_dst = v_addr;
    else
        SockAddrStringValue(v_spec_dst);

    memset(&amp;pktinfo, 0, sizeof(pktinfo));

    memset(&amp;sa, 0, sizeof(sa));
    if (RSTRING_LEN(v_addr) != sizeof(sa))
        rb_raise(rb_eArgError, &quot;addr size different to AF_INET sockaddr&quot;);
    memcpy(&amp;sa, RSTRING_PTR(v_addr), sizeof(sa));
    if (sa.sin_family != AF_INET)
        rb_raise(rb_eArgError, &quot;addr is not AF_INET sockaddr&quot;);
    memcpy(&amp;pktinfo.ipi_addr, &amp;sa.sin_addr, sizeof(pktinfo.ipi_addr));

    pktinfo.ipi_ifindex = ifindex;

    memset(&amp;sa, 0, sizeof(sa));
    if (RSTRING_LEN(v_spec_dst) != sizeof(sa))
        rb_raise(rb_eArgError, &quot;spec_dat size different to AF_INET sockaddr&quot;);
    memcpy(&amp;sa, RSTRING_PTR(v_spec_dst), sizeof(sa));
    if (sa.sin_family != AF_INET)
        rb_raise(rb_eArgError, &quot;spec_dst is not AF_INET sockaddr&quot;);
    memcpy(&amp;pktinfo.ipi_spec_dst, &amp;sa.sin_addr, sizeof(pktinfo.ipi_spec_dst));

    return ancdata_new(AF_INET, IPPROTO_IP, IP_PKTINFO, rb_str_new((char *)&amp;pktinfo, sizeof(pktinfo)));
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="ipv6_pktinfo-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>Socket::AncillaryData.ipv6_pktinfo</strong>(addr, ifindex) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns new ancillary data for IPV6_PKTINFO.</p>

<p>IPV6_PKTINFO is defined by RFC 3542.</p>

<pre class="ruby"><span class="ruby-identifier">addr</span> = <span class="ruby-constant">Addrinfo</span>.<span class="ruby-identifier">ip</span>(<span class="ruby-string">&quot;::1&quot;</span>)
<span class="ruby-identifier">ifindex</span> = <span class="ruby-value">0</span>
<span class="ruby-identifier">p</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">ipv6_pktinfo</span>(<span class="ruby-identifier">addr</span>, <span class="ruby-identifier">ifindex</span>)
<span class="ruby-comment">#=&gt; #&lt;Socket::AncillaryData: INET6 IPV6 PKTINFO ::1 ifindex:0&gt;</span>
</pre>


  </div>
</div>
<div class="tags">
  
  


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 531</span>

static VALUE
ancillary_s_ipv6_pktinfo(VALUE self, VALUE v_addr, VALUE v_ifindex)
{
    unsigned int ifindex;
    struct sockaddr_in6 sa;
    struct in6_pktinfo pktinfo;

    SockAddrStringValue(v_addr);
    ifindex = NUM2UINT(v_ifindex);

    memset(&amp;pktinfo, 0, sizeof(pktinfo));

    memset(&amp;sa, 0, sizeof(sa));
    if (RSTRING_LEN(v_addr) != sizeof(sa))
        rb_raise(rb_eArgError, &quot;addr size different to AF_INET6 sockaddr&quot;);
    memcpy(&amp;sa, RSTRING_PTR(v_addr), sizeof(sa));
    if (sa.sin6_family != AF_INET6)
        rb_raise(rb_eArgError, &quot;addr is not AF_INET6 sockaddr&quot;);
    memcpy(&amp;pktinfo.ipi6_addr, &amp;sa.sin6_addr, sizeof(pktinfo.ipi6_addr));

    pktinfo.ipi6_ifindex = ifindex;

    return ancdata_new(AF_INET6, IPPROTO_IPV6, IPV6_PKTINFO, rb_str_new((char *)&amp;pktinfo, sizeof(pktinfo)));
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unix_rights-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>Socket::AncillaryData.unix_rights</strong>(io1, io2, ...) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Creates a new Socket::AncillaryData object which contains file descriptors
as data.</p>

<pre class="ruby"><span class="ruby-identifier">p</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">unix_rights</span>(<span class="ruby-constant">STDERR</span>)
<span class="ruby-comment">#=&gt; #&lt;Socket::AncillaryData: UNIX SOCKET RIGHTS 2&gt;</span>
</pre>


  </div>
</div>
<div class="tags">
  
  


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 189</span>

static VALUE
ancillary_s_unix_rights(int argc, VALUE *argv, VALUE klass)
{
    VALUE result, str, ary;
    int i;

    ary = rb_ary_new();

    for (i = 0 ; i &lt; argc; i++) {
        VALUE obj = argv[i];
        if (TYPE(obj) != T_FILE) {
            rb_raise(rb_eTypeError, &quot;IO expected&quot;);
        }
        rb_ary_push(ary, obj);
    }

    str = rb_str_buf_new(sizeof(int) * argc);

    for (i = 0 ; i &lt; argc; i++) {
        VALUE obj = RARRAY_PTR(ary)[i];
        rb_io_t *fptr;
        int fd;
        GetOpenFile(obj, fptr);
        fd = fptr-&gt;fd;
        rb_str_buf_cat(str, (char *)&amp;fd, sizeof(int));
    }

    result = ancdata_new(AF_UNIX, SOL_SOCKET, SCM_RIGHTS, str);
    rb_ivar_set(result, rb_intern(&quot;unix_rights&quot;), ary);
    return result;
}</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="cmsg_is?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>cmsg_is?</strong>(level, type) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>tests the level and type of <em>ancillarydata</em>.</p>

<pre class="ruby"><span class="ruby-identifier">ancdata</span> = <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">new</span>(:<span class="ruby-constant">INET6</span>, :<span class="ruby-constant">IPV6</span>, :<span class="ruby-constant">PKTINFO</span>, <span class="ruby-string">&quot;&quot;</span>)
<span class="ruby-identifier">ancdata</span>.<span class="ruby-identifier">cmsg_is?</span>(<span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">IPPROTO_IPV6</span>, <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">IPV6_PKTINFO</span>) <span class="ruby-comment">#=&gt; true</span>
<span class="ruby-identifier">ancdata</span>.<span class="ruby-identifier">cmsg_is?</span>(:<span class="ruby-constant">IPV6</span>, :<span class="ruby-constant">PKTINFO</span>)       <span class="ruby-comment">#=&gt; true</span>
<span class="ruby-identifier">ancdata</span>.<span class="ruby-identifier">cmsg_is?</span>(:<span class="ruby-constant">IP</span>, :<span class="ruby-constant">PKTINFO</span>)         <span class="ruby-comment">#=&gt; false</span>
<span class="ruby-identifier">ancdata</span>.<span class="ruby-identifier">cmsg_is?</span>(:<span class="ruby-constant">SOCKET</span>, :<span class="ruby-constant">RIGHTS</span>)      <span class="ruby-comment">#=&gt; false</span>
</pre>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1090
1091
1092
1093
1094
1095
1096
1097
1098
1099
1100
1101
1102</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 1090</span>

static VALUE
ancillary_cmsg_is_p(VALUE self, VALUE vlevel, VALUE vtype)
{
    int family = ancillary_family(self);
    int level = rsock_level_arg(family, vlevel);
    int type = rsock_cmsg_type_arg(family, level, vtype);

    if (ancillary_level(self) == level &amp;&amp;
        ancillary_type(self) == type)
        return Qtrue;
    else
        return Qfalse;
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="data-instance_method">
  
    - (<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>) <strong>data</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>returns the cmsg data as a string.</p>

<pre class="ruby"><span class="ruby-identifier">p</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">new</span>(:<span class="ruby-constant">INET6</span>, :<span class="ruby-constant">IPV6</span>, :<span class="ruby-constant">PKTINFO</span>, <span class="ruby-string">&quot;&quot;</span>).<span class="ruby-identifier">data</span>
<span class="ruby-comment">#=&gt; &quot;&quot;</span>
</pre>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


171
172
173
174
175
176
177</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 171</span>

static VALUE
ancillary_data(VALUE self)
{
    VALUE v = rb_attr_get(self, rb_intern(&quot;data&quot;));
    StringValue(v);
    return v;
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="family-instance_method">
  
    - (<tt><span class='object_link'><a href="../Integer.html" title="Integer (class)">Integer</a></span></tt>) <strong>family</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>returns the socket family as an integer.</p>

<pre class="ruby"><span class="ruby-identifier">p</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">new</span>(:<span class="ruby-constant">INET6</span>, :<span class="ruby-constant">IPV6</span>, :<span class="ruby-constant">PKTINFO</span>, <span class="ruby-string">&quot;&quot;</span>).<span class="ruby-identifier">family</span>
<span class="ruby-comment">#=&gt; 10</span>
</pre>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Integer.html" title="Integer (class)">Integer</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


112
113
114
115
116</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 112</span>

static VALUE
ancillary_family_m(VALUE self)
{
    return INT2NUM(ancillary_family(self));
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="inspect-instance_method">
  
    - (<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>) <strong>inspect</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>returns a string which shows ancillarydata in human-readable form.</p>

<pre class="ruby"><span class="ruby-identifier">p</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">new</span>(:<span class="ruby-constant">INET6</span>, :<span class="ruby-constant">IPV6</span>, :<span class="ruby-constant">PKTINFO</span>, <span class="ruby-string">&quot;&quot;</span>).<span class="ruby-identifier">inspect</span>
<span class="ruby-comment">#=&gt; &quot;#&lt;Socket::AncillaryData: INET6 IPV6 PKTINFO \&quot;\&quot;&gt;&quot;</span>
</pre>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


952
953
954
955
956
957
958
959
960
961
962
963
964
965
966
967
968
969
970
971
972
973
974
975
976
977
978
979
980
981
982
983
984
985
986
987
988
989
990
991
992
993
994
995
996
997
998
999
1000
1001
1002
1003
1004
1005
1006
1007
1008
1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026
1027
1028
1029
1030
1031
1032
1033
1034
1035
1036
1037
1038
1039
1040
1041
1042
1043
1044
1045
1046
1047
1048
1049
1050
1051
1052
1053
1054
1055
1056
1057
1058
1059
1060
1061
1062
1063
1064
1065
1066
1067
1068
1069
1070
1071
1072
1073
1074
1075
1076</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 952</span>

static VALUE
ancillary_inspect(VALUE self)
{
    VALUE ret;
    int family, level, type;
    VALUE data;
    ID family_id, level_id, type_id;
    VALUE vtype;
    int inspected;

    family = ancillary_family(self);
    level = ancillary_level(self);
    type = ancillary_type(self);
    data = ancillary_data(self);

    ret = rb_sprintf(&quot;#&lt;%s:&quot;, rb_obj_classname(self));

    family_id = rsock_intern_family_noprefix(family);
    if (family_id)
        rb_str_catf(ret, &quot; %s&quot;, rb_id2name(family_id));
    else
        rb_str_catf(ret, &quot; family:%d&quot;, family);

    if (level == SOL_SOCKET) {
        rb_str_cat2(ret, &quot; SOCKET&quot;);

        type_id = rsock_intern_scm_optname(type);
        if (type_id)
            rb_str_catf(ret, &quot; %s&quot;, rb_id2name(type_id));
        else
            rb_str_catf(ret, &quot; cmsg_type:%d&quot;, type);
    }
    else if (IS_IP_FAMILY(family)) {
        level_id = rsock_intern_iplevel(level);
        if (level_id)
            rb_str_catf(ret, &quot; %s&quot;, rb_id2name(level_id));
        else
            rb_str_catf(ret, &quot; cmsg_level:%d&quot;, level);

        vtype = ip_cmsg_type_to_sym(level, type);
        if (SYMBOL_P(vtype))
            rb_str_catf(ret, &quot; %s&quot;, rb_id2name(SYM2ID(vtype)));
        else
            rb_str_catf(ret, &quot; cmsg_type:%d&quot;, type);
    }
    else {
        rb_str_catf(ret, &quot; cmsg_level:%d&quot;, level);
        rb_str_catf(ret, &quot; cmsg_type:%d&quot;, type);
    }

    inspected = 0;

    if (level == SOL_SOCKET)
        family = AF_UNSPEC;

    switch (family) {
      case AF_UNSPEC:
        switch (level) {
#        if defined(SOL_SOCKET)
          case SOL_SOCKET:
            switch (type) {
#            if defined(SCM_TIMESTAMP) /* GNU/Linux, FreeBSD, NetBSD, OpenBSD, MacOS X, Solaris */
              case SCM_TIMESTAMP: inspected = inspect_timeval_as_abstime(level, type, data, ret); break;
#            endif
#            if defined(SCM_TIMESTAMPNS) /* GNU/Linux */
              case SCM_TIMESTAMPNS: inspected = inspect_timespec_as_abstime(level, type, data, ret); break;
#            endif
#            if defined(SCM_BINTIME) /* FreeBSD */
              case SCM_BINTIME: inspected = inspect_bintime_as_abstime(level, type, data, ret); break;
#            endif
#            if defined(SCM_RIGHTS) /* 4.4BSD */
              case SCM_RIGHTS: inspected = anc_inspect_socket_rights(level, type, data, ret); break;
#            endif
#            if defined(SCM_CREDENTIALS) /* GNU/Linux */
              case SCM_CREDENTIALS: inspected = anc_inspect_passcred_credentials(level, type, data, ret); break;
#            endif
#            if defined(INSPECT_SCM_CREDS) /* NetBSD */
              case SCM_CREDS: inspected = anc_inspect_socket_creds(level, type, data, ret); break;
#            endif
            }
            break;
#        endif
        }
        break;

      case AF_INET:
#ifdef INET6
      case AF_INET6:
#endif
        switch (level) {
#        if defined(IPPROTO_IP)
          case IPPROTO_IP:
            switch (type) {
#            if defined(IP_RECVDSTADDR) /* 4.4BSD */
              case IP_RECVDSTADDR: inspected = anc_inspect_ip_recvdstaddr(level, type, data, ret); break;
#            endif
#            if defined(IP_PKTINFO) &amp;&amp; defined(HAVE_STRUCT_IN_PKTINFO_IPI_SPEC_DST) /* GNU/Linux */
              case IP_PKTINFO: inspected = anc_inspect_ip_pktinfo(level, type, data, ret); break;
#            endif
            }
            break;
#        endif

#        if defined(IPPROTO_IPV6)
          case IPPROTO_IPV6:
            switch (type) {
#            if defined(IPV6_PKTINFO) /* RFC 3542 */
              case IPV6_PKTINFO: inspected = anc_inspect_ipv6_pktinfo(level, type, data, ret); break;
#            endif
            }
            break;
#        endif
        }
        break;
    }

    if (!inspected) {
        rb_str_cat2(ret, &quot; &quot;);
        rb_str_append(ret, rb_str_dump(data));
    }

    rb_str_cat2(ret, &quot;&gt;&quot;);

    return ret;
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="int-instance_method">
  
    - (<tt><span class='object_link'><a href="../Integer.html" title="Integer (class)">Integer</a></span></tt>) <strong>int</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the data in <em>ancillarydata</em> as an int.</p>

<p>The size and endian is dependent on the host.</p>

<pre class="ruby"><span class="ruby-identifier">ancdata</span> = <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">int</span>(:<span class="ruby-constant">UNIX</span>, :<span class="ruby-constant">SOCKET</span>, :<span class="ruby-constant">RIGHTS</span>, <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">fileno</span>)
<span class="ruby-identifier">p</span> <span class="ruby-identifier">ancdata</span>.<span class="ruby-identifier">int</span> <span class="ruby-comment">#=&gt; 2</span>
</pre>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Integer.html" title="Integer (class)">Integer</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


385
386
387
388
389
390
391
392
393
394
395</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 385</span>

static VALUE
ancillary_int(VALUE self)
{
    VALUE data;
    int i;
    data = ancillary_data(self);
    if (RSTRING_LEN(data) != sizeof(int))
        rb_raise(rb_eTypeError, &quot;size differ.  expected as sizeof(int)=%d but %ld&quot;, (int)sizeof(int), (long)RSTRING_LEN(data));
    memcpy((char*)&amp;i, RSTRING_PTR(data), sizeof(int));
    return INT2NUM(i);
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="ip_pktinfo-instance_method">
  
    - (<tt><span class='object_link'><a href="../Array.html" title="Array (class)">Array</a></span></tt>) <strong>ip_pktinfo</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Extracts addr, ifindex and spec_dst from IP_PKTINFO ancillary data.</p>

<p>IP_PKTINFO is not standard.</p>

<p>Supported platform: GNU/Linux</p>

<pre class="ruby"><span class="ruby-identifier">addr</span> = <span class="ruby-constant">Addrinfo</span>.<span class="ruby-identifier">ip</span>(<span class="ruby-string">&quot;127.0.0.1&quot;</span>)
<span class="ruby-identifier">ifindex</span> = <span class="ruby-value">0</span>
<span class="ruby-identifier">spec_dest</span> = <span class="ruby-constant">Addrinfo</span>.<span class="ruby-identifier">ip</span>(<span class="ruby-string">&quot;127.0.0.1&quot;</span>)
<span class="ruby-identifier">ancdata</span> = <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">ip_pktinfo</span>(<span class="ruby-identifier">addr</span>, <span class="ruby-identifier">ifindex</span>, <span class="ruby-identifier">spec_dest</span>)
<span class="ruby-identifier">p</span> <span class="ruby-identifier">ancdata</span>.<span class="ruby-identifier">ip_pktinfo</span>
<span class="ruby-comment">#=&gt; [#&lt;Addrinfo: 127.0.0.1&gt;, 0, #&lt;Addrinfo: 127.0.0.1&gt;]</span>
</pre>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Array.html" title="Array (class)">Array</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 481</span>

static VALUE
ancillary_ip_pktinfo(VALUE self)
{
    int level, type;
    VALUE data;
    struct in_pktinfo pktinfo;
    struct sockaddr_in sa;
    VALUE v_spec_dst, v_addr;

    level = ancillary_level(self);
    type = ancillary_type(self);
    data = ancillary_data(self);

    if (level != IPPROTO_IP || type != IP_PKTINFO ||
        RSTRING_LEN(data) != sizeof(struct in_pktinfo)) {
        rb_raise(rb_eTypeError, &quot;IP_PKTINFO ancillary data expected&quot;);
    }

    memcpy(&amp;pktinfo, RSTRING_PTR(data), sizeof(struct in_pktinfo));
    memset(&amp;sa, 0, sizeof(sa));

    sa.sin_family = AF_INET;
    memcpy(&amp;sa.sin_addr, &amp;pktinfo.ipi_addr, sizeof(sa.sin_addr));
    v_addr = rsock_addrinfo_new((struct sockaddr *)&amp;sa, sizeof(sa), PF_INET, 0, 0, Qnil, Qnil);

    sa.sin_family = AF_INET;
    memcpy(&amp;sa.sin_addr, &amp;pktinfo.ipi_spec_dst, sizeof(sa.sin_addr));
    v_spec_dst = rsock_addrinfo_new((struct sockaddr *)&amp;sa, sizeof(sa), PF_INET, 0, 0, Qnil, Qnil);

    return rb_ary_new3(3, v_addr, UINT2NUM(pktinfo.ipi_ifindex), v_spec_dst);
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="ipv6_pktinfo-instance_method">
  
    - (<tt><span class='object_link'><a href="../Array.html" title="Array (class)">Array</a></span></tt>) <strong>ipv6_pktinfo</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Extracts addr and ifindex from IPV6_PKTINFO ancillary data.</p>

<p>IPV6_PKTINFO is defined by RFC 3542.</p>

<pre class="ruby"><span class="ruby-identifier">addr</span> = <span class="ruby-constant">Addrinfo</span>.<span class="ruby-identifier">ip</span>(<span class="ruby-string">&quot;::1&quot;</span>)
<span class="ruby-identifier">ifindex</span> = <span class="ruby-value">0</span>
<span class="ruby-identifier">ancdata</span> = <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">ipv6_pktinfo</span>(<span class="ruby-identifier">addr</span>, <span class="ruby-identifier">ifindex</span>)
<span class="ruby-identifier">p</span> <span class="ruby-identifier">ancdata</span>.<span class="ruby-identifier">ipv6_pktinfo</span> <span class="ruby-comment">#=&gt; [#&lt;Addrinfo: ::1&gt;, 0]</span>
</pre>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Array.html" title="Array (class)">Array</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


601
602
603
604
605
606
607
608
609
610
611</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 601</span>

static VALUE
ancillary_ipv6_pktinfo(VALUE self)
{
    struct in6_pktinfo pktinfo;
    struct sockaddr_in6 sa;
    VALUE v_addr;

    extract_ipv6_pktinfo(self, &amp;pktinfo, &amp;sa);
    v_addr = rsock_addrinfo_new((struct sockaddr *)&amp;sa, (socklen_t)sizeof(sa), PF_INET6, 0, 0, Qnil, Qnil);
    return rb_ary_new3(2, v_addr, UINT2NUM(pktinfo.ipi6_ifindex));
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="ipv6_pktinfo_addr-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>ipv6_pktinfo_addr</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Extracts addr from IPV6_PKTINFO ancillary data.</p>

<p>IPV6_PKTINFO is defined by RFC 3542.</p>

<pre class="ruby"><span class="ruby-identifier">addr</span> = <span class="ruby-constant">Addrinfo</span>.<span class="ruby-identifier">ip</span>(<span class="ruby-string">&quot;::1&quot;</span>)
<span class="ruby-identifier">ifindex</span> = <span class="ruby-value">0</span>
<span class="ruby-identifier">ancdata</span> = <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">ipv6_pktinfo</span>(<span class="ruby-identifier">addr</span>, <span class="ruby-identifier">ifindex</span>)
<span class="ruby-identifier">p</span> <span class="ruby-identifier">ancdata</span>.<span class="ruby-identifier">ipv6_pktinfo_addr</span> <span class="ruby-comment">#=&gt; #&lt;Addrinfo: ::1&gt;</span>
</pre>


  </div>
</div>
<div class="tags">
  
  


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


631
632
633
634
635
636
637
638</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 631</span>

static VALUE
ancillary_ipv6_pktinfo_addr(VALUE self)
{
    struct in6_pktinfo pktinfo;
    struct sockaddr_in6 sa;
    extract_ipv6_pktinfo(self, &amp;pktinfo, &amp;sa);
    return rsock_addrinfo_new((struct sockaddr *)&amp;sa, (socklen_t)sizeof(sa), PF_INET6, 0, 0, Qnil, Qnil);
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="ipv6_pktinfo_ifindex-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>ipv6_pktinfo_ifindex</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Extracts ifindex from IPV6_PKTINFO ancillary data.</p>

<p>IPV6_PKTINFO is defined by RFC 3542.</p>

<pre class="ruby"><span class="ruby-identifier">addr</span> = <span class="ruby-constant">Addrinfo</span>.<span class="ruby-identifier">ip</span>(<span class="ruby-string">&quot;::1&quot;</span>)
<span class="ruby-identifier">ifindex</span> = <span class="ruby-value">0</span>
<span class="ruby-identifier">ancdata</span> = <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">ipv6_pktinfo</span>(<span class="ruby-identifier">addr</span>, <span class="ruby-identifier">ifindex</span>)
<span class="ruby-identifier">p</span> <span class="ruby-identifier">ancdata</span>.<span class="ruby-identifier">ipv6_pktinfo_ifindex</span> <span class="ruby-comment">#=&gt; 0</span>
</pre>


  </div>
</div>
<div class="tags">
  
  


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


658
659
660
661
662
663
664
665</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 658</span>

static VALUE
ancillary_ipv6_pktinfo_ifindex(VALUE self)
{
    struct in6_pktinfo pktinfo;
    struct sockaddr_in6 sa;
    extract_ipv6_pktinfo(self, &amp;pktinfo, &amp;sa);
    return UINT2NUM(pktinfo.ipi6_ifindex);
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="level-instance_method">
  
    - (<tt><span class='object_link'><a href="../Integer.html" title="Integer (class)">Integer</a></span></tt>) <strong>level</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>returns the cmsg level as an integer.</p>

<pre class="ruby"><span class="ruby-identifier">p</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">new</span>(:<span class="ruby-constant">INET6</span>, :<span class="ruby-constant">IPV6</span>, :<span class="ruby-constant">PKTINFO</span>, <span class="ruby-string">&quot;&quot;</span>).<span class="ruby-identifier">level</span>
<span class="ruby-comment">#=&gt; 41</span>
</pre>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Integer.html" title="Integer (class)">Integer</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


134
135
136
137
138</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 134</span>

static VALUE
ancillary_level_m(VALUE self)
{
    return INT2NUM(ancillary_level(self));
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="timestamp-instance_method">
  
    - (<tt><span class='object_link'><a href="../Time.html" title="Time (class)">Time</a></span></tt>) <strong>timestamp</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>returns the timestamp as a time object.</p>

<p><em>ancillarydata</em> should be one of following type:</p>
<ul><li>
<p>SOL_SOCKET/SCM_TIMESTAMP (micro second) GNU/Linux, FreeBSD, NetBSD,
OpenBSD, Solaris, MacOS X</p>
</li><li>
<p>SOL_SOCKET/SCM_TIMESTAMPNS (nano second) GNU/Linux</p>
</li><li>
<p>SOL_SOCKET/SCM_BINTIME (2**(-64) second) FreeBSD</p>

<p>Addrinfo.udp(“127.0.0.1”, 0).bind {|s1|</p>

<pre class="ruby"><span class="ruby-constant">Addrinfo</span>.<span class="ruby-identifier">udp</span>(<span class="ruby-string">&quot;127.0.0.1&quot;</span>, <span class="ruby-value">0</span>).<span class="ruby-identifier">bind</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s2</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">s1</span>.<span class="ruby-identifier">setsockopt</span>(:<span class="ruby-constant">SOCKET</span>, :<span class="ruby-constant">TIMESTAMP</span>, <span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">s2</span>.<span class="ruby-identifier">send</span> <span class="ruby-string">&quot;a&quot;</span>, <span class="ruby-value">0</span>, <span class="ruby-identifier">s1</span>.<span class="ruby-identifier">local_address</span>
  <span class="ruby-identifier">ctl</span> = <span class="ruby-identifier">s1</span>.<span class="ruby-identifier">recvmsg</span>.<span class="ruby-identifier">last</span>
  <span class="ruby-identifier">p</span> <span class="ruby-identifier">ctl</span>    <span class="ruby-comment">#=&gt; #&lt;Socket::AncillaryData: INET SOCKET TIMESTAMP 2009-02-24 17:35:46.775581&gt;</span>
  <span class="ruby-identifier">t</span> = <span class="ruby-identifier">ctl</span>.<span class="ruby-identifier">timestamp</span>
  <span class="ruby-identifier">p</span> <span class="ruby-identifier">t</span>      <span class="ruby-comment">#=&gt; 2009-02-24 17:35:46 +0900</span>
  <span class="ruby-identifier">p</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">usec</span> <span class="ruby-comment">#=&gt; 775581</span>
  <span class="ruby-identifier">p</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">nsec</span> <span class="ruby-comment">#=&gt; 775581000</span>
}
</pre>

<p>}</p>
</li></ul>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Time.html" title="Time (class)">Time</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 298</span>

static VALUE
ancillary_timestamp(VALUE self)
{
    int level, type;
    VALUE data;
    VALUE result = Qnil;

    level = ancillary_level(self);
    type = ancillary_type(self);
    data = ancillary_data(self);

# ifdef SCM_TIMESTAMP
    if (level == SOL_SOCKET &amp;&amp; type == SCM_TIMESTAMP &amp;&amp;
        RSTRING_LEN(data) == sizeof(struct timeval)) {
        struct timeval tv;
        memcpy((char*)&amp;tv, RSTRING_PTR(data), sizeof(tv));
        result = rb_time_new(tv.tv_sec, tv.tv_usec);
    }
# endif

# ifdef SCM_TIMESTAMPNS
    if (level == SOL_SOCKET &amp;&amp; type == SCM_TIMESTAMPNS &amp;&amp;
        RSTRING_LEN(data) == sizeof(struct timespec)) {
        struct timespec ts;
        memcpy((char*)&amp;ts, RSTRING_PTR(data), sizeof(ts));
        result = rb_time_nano_new(ts.tv_sec, ts.tv_nsec);
    }
# endif

#define add(x,y) (rb_funcall((x), '+', 1, (y)))
#define mul(x,y) (rb_funcall((x), '*', 1, (y)))
#define quo(x,y) (rb_funcall((x), rb_intern(&quot;quo&quot;), 1, (y)))

# ifdef SCM_BINTIME
    if (level == SOL_SOCKET &amp;&amp; type == SCM_BINTIME &amp;&amp;
        RSTRING_LEN(data) == sizeof(struct bintime)) {
        struct bintime bt;
	VALUE d, timev;
        memcpy((char*)&amp;bt, RSTRING_PTR(data), sizeof(bt));
	d = ULL2NUM(0x100000000ULL);
	d = mul(d,d);
	timev = add(TIMET2NUM(bt.sec), quo(ULL2NUM(bt.frac), d));
        result = rb_time_num_new(timev, Qnil);
    }
# endif

    if (result == Qnil)
        rb_raise(rb_eTypeError, &quot;timestamp ancillary data expected&quot;);

    return result;
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="type-instance_method">
  
    - (<tt><span class='object_link'><a href="../Integer.html" title="Integer (class)">Integer</a></span></tt>) <strong>type</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>returns the cmsg type as an integer.</p>

<pre class="ruby"><span class="ruby-identifier">p</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">new</span>(:<span class="ruby-constant">INET6</span>, :<span class="ruby-constant">IPV6</span>, :<span class="ruby-constant">PKTINFO</span>, <span class="ruby-string">&quot;&quot;</span>).<span class="ruby-identifier">type</span>
<span class="ruby-comment">#=&gt; 2</span>
</pre>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Integer.html" title="Integer (class)">Integer</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


156
157
158
159
160</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 156</span>

static VALUE
ancillary_type_m(VALUE self)
{
    return INT2NUM(ancillary_type(self));
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unix_rights-instance_method">
  
    - (<tt>array-of-IOs</tt><sup>?</sup>) <strong>unix_rights</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>returns the array of IO objects for SCM_RIGHTS control message in UNIX
domain socket.</p>

<p>The class of the IO objects in the array is IO or Socket.</p>

<p>The array is attached to <em>ancillarydata</em> when it is instantiated.
For example, BasicSocket#recvmsg attach the array when receives a
SCM_RIGHTS control message and :scm_rights=&gt;true option is given.</p>

<pre class="ruby"><span class="ruby-comment"># recvmsg needs :scm_rights=&gt;true for unix_rights</span>
<span class="ruby-identifier">s1</span>, <span class="ruby-identifier">s2</span> = <span class="ruby-constant">UNIXSocket</span>.<span class="ruby-identifier">pair</span>
<span class="ruby-identifier">p</span> <span class="ruby-identifier">s1</span>                                         <span class="ruby-comment">#=&gt; #&lt;UNIXSocket:fd 3&gt;</span>
<span class="ruby-identifier">s1</span>.<span class="ruby-identifier">sendmsg</span> <span class="ruby-string">&quot;stdin and a socket&quot;</span>, <span class="ruby-value">0</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">unix_rights</span>(<span class="ruby-constant">STDIN</span>, <span class="ruby-identifier">s1</span>)
<span class="ruby-identifier">_</span>, <span class="ruby-identifier">_</span>, <span class="ruby-identifier">_</span>, <span class="ruby-identifier">ctl</span> = <span class="ruby-identifier">s2</span>.<span class="ruby-identifier">recvmsg</span>(:<span class="ruby-identifier">scm_rights=</span><span class="ruby-operator">&gt;</span><span class="ruby-keyword">true</span>)
<span class="ruby-identifier">p</span> <span class="ruby-identifier">ctl</span>                                        <span class="ruby-comment">#=&gt; #&lt;Socket::AncillaryData: UNIX SOCKET RIGHTS 6 7&gt;</span>
<span class="ruby-identifier">p</span> <span class="ruby-identifier">ctl</span>.<span class="ruby-identifier">unix_rights</span>                            <span class="ruby-comment">#=&gt; [#&lt;IO:fd 6&gt;, #&lt;Socket:fd 7&gt;]</span>
<span class="ruby-identifier">p</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">identical?</span>(<span class="ruby-constant">STDIN</span>, <span class="ruby-identifier">ctl</span>.<span class="ruby-identifier">unix_rights</span>[<span class="ruby-value">0</span>]) <span class="ruby-comment">#=&gt; true</span>
<span class="ruby-identifier">p</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">identical?</span>(<span class="ruby-identifier">s1</span>, <span class="ruby-identifier">ctl</span>.<span class="ruby-identifier">unix_rights</span>[<span class="ruby-value">1</span>])    <span class="ruby-comment">#=&gt; true</span>

<span class="ruby-comment"># If :scm_rights=&gt;true is not given, unix_rights returns nil</span>
<span class="ruby-identifier">s1</span>, <span class="ruby-identifier">s2</span> = <span class="ruby-constant">UNIXSocket</span>.<span class="ruby-identifier">pair</span>
<span class="ruby-identifier">s1</span>.<span class="ruby-identifier">sendmsg</span> <span class="ruby-string">&quot;stdin and a socket&quot;</span>, <span class="ruby-value">0</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">AncillaryData</span>.<span class="ruby-identifier">unix_rights</span>(<span class="ruby-constant">STDIN</span>, <span class="ruby-identifier">s1</span>)
<span class="ruby-identifier">_</span>, <span class="ruby-identifier">_</span>, <span class="ruby-identifier">_</span>, <span class="ruby-identifier">ctl</span> = <span class="ruby-identifier">s2</span>.<span class="ruby-identifier">recvmsg</span>
<span class="ruby-identifier">p</span> <span class="ruby-identifier">ctl</span> <span class="ruby-comment">#=&gt; #&lt;Socket::AncillaryData: UNIX SOCKET RIGHTS 6 7&gt;</span>
<span class="ruby-identifier">p</span> <span class="ruby-identifier">ctl</span>.<span class="ruby-identifier">unix_rights</span> <span class="ruby-comment">#=&gt; nil</span>
</pre>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>array-of-IOs</tt>, <tt>nil</tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


255
256
257
258
259
260
261
262
263
264
265
266
267</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'ext/socket/ancdata.c', line 255</span>

static VALUE
ancillary_unix_rights(VALUE self)
{
    int level, type;

    level = ancillary_level(self);
    type = ancillary_type(self);

    if (level != SOL_SOCKET || type != SCM_RIGHTS)
        rb_raise(rb_eTypeError, &quot;SCM_RIGHTS ancillary data expected&quot;);

    return rb_attr_get(self, rb_intern(&quot;unix_rights&quot;));
}</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Wed Nov 19 10:17:17 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.4 (ruby-1.9.3).
</div>

  </body>
</html>