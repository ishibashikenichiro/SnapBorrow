<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: LendLogController
  
    &mdash; Documentation by YARD 0.8.7.4
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!LendLogController.html";
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (L)</a> &raquo;
    
    
    <span class="title">LendLogController</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: LendLogController
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></span>
      
        <ul class="fullTree">
          <li><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></li>
          
            <li class="next">ActionController::Base</li>
          
            <li class="next"><span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></li>
          
            <li class="next">LendLogController</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">app/controllers/lend_log_controller.rb</dd>
  
</dl>
<div class="clear"></div>








  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#array_to_json-instance_method" title="#array_to_json (instance method)">- (String) <strong>array_to_json</strong>(status, book_code) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>借用時のJSON作成.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#array_to_json_shelf_name-instance_method" title="#array_to_json_shelf_name (instance method)">- (String) <strong>array_to_json_shelf_name</strong>(status, book_code, shelf_name) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>返却時のJSON作成.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#array_to_json_shelves-instance_method" title="#array_to_json_shelves (instance method)">- (String) <strong>array_to_json_shelves</strong>(status, book_code, shelves, shelf_name) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>本棚選択のためのJSON作成.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create-instance_method" title="#create (instance method)">- (String) <strong>create</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>借用ログを作る 結果一覧 0:返却 1:借用 -1:すべての図書が借用されていた場合 -2:図書が登録されていなかった場合
-3:グループに所属していなかった場合 -4:該当する図書が複数の本棚にあった場合 -5:該当する図書の本棚を登録する必要がある場合.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_shelves-instance_method" title="#get_shelves (instance method)">- (Object) <strong>get_shelves</strong>(group_id) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>本棚IDと本棚名の取得.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#index-instance_method" title="#index (instance method)">- (Object) <strong>index</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>借用ログ一覧.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#push_not_possess-instance_method" title="#push_not_possess (instance method)">- (Object) <strong>push_not_possess</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>図書を持っていない場合.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#push_possess-instance_method" title="#push_possess (instance method)">- (Object) <strong>push_possess</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>図書を持っている場合.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#select_shelf_lend-instance_method" title="#select_shelf_lend (instance method)">- (Object) <strong>select_shelf_lend</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>本棚を選択して借用する場合.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#temporary_create-instance_method" title="#temporary_create (instance method)">- (String) <strong>temporary_create</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>一時借用ログを作る.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="ApplicationController.html#get_group_id-instance_method" title="ApplicationController#get_group_id (method)">#get_group_id</a></span></p>

  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="array_to_json-instance_method">
  
    - (<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>) <strong>array_to_json</strong>(status, book_code) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>借用時のJSON作成</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>status</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Fixnum.html" title="Fixnum (class)">Fixnum</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>結果の状態</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>book_code</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>図書コード</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>結果と図書コードを含むJSON形式の文字列</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


418
419
420
421
422
423
424
425
426</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/lend_log_controller.rb', line 418</span>

<span class='kw'>def</span> <span class='id identifier rubyid_array_to_json'>array_to_json</span><span class='lparen'>(</span><span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_json_array'>json_array</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_result_array'>result_array</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_result_array'>result_array</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>status</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_status'>status</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_result_array'>result_array</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>book_code</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_book_code'>book_code</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_json_array'>json_array</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>result</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_result_array'>result_array</span>
  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_generate'>generate</span><span class='lparen'>(</span><span class='id identifier rubyid_json_array'>json_array</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="array_to_json_shelf_name-instance_method">
  
    - (<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>) <strong>array_to_json_shelf_name</strong>(status, book_code, shelf_name) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>返却時のJSON作成</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>status</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Fixnum.html" title="Fixnum (class)">Fixnum</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>結果の状態</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>book_code</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>図書コード</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>shelf_name</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>本棚名</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>結果と図書コードと本棚名を含むJSON形式の文字列</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


451
452
453
454
455
456
457
458
459
460</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/lend_log_controller.rb', line 451</span>

<span class='kw'>def</span> <span class='id identifier rubyid_array_to_json_shelf_name'>array_to_json_shelf_name</span><span class='lparen'>(</span><span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_shelf_name'>shelf_name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_json_array'>json_array</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_result_array'>result_array</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_result_array'>result_array</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>status</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_status'>status</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_result_array'>result_array</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>book_code</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_book_code'>book_code</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_result_array'>result_array</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>shelf_name</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_shelf_name'>shelf_name</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_json_array'>json_array</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>result</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_result_array'>result_array</span>
  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_generate'>generate</span><span class='lparen'>(</span><span class='id identifier rubyid_json_array'>json_array</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="array_to_json_shelves-instance_method">
  
    - (<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>) <strong>array_to_json_shelves</strong>(status, book_code, shelves, shelf_name) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>本棚選択のためのJSON作成</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>status</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Fixnum.html" title="Fixnum (class)">Fixnum</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>結果の状態</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>book_code</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>図書コード</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>shelves</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Array.html" title="Array (class)">Array</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>本棚IDの配列</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>結果と図書コードと本棚IDを含むJSON形式の文字列</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


433
434
435
436
437
438
439
440
441
442
443</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/lend_log_controller.rb', line 433</span>

<span class='kw'>def</span> <span class='id identifier rubyid_array_to_json_shelves'>array_to_json_shelves</span><span class='lparen'>(</span><span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_shelves'>shelves</span><span class='comma'>,</span> <span class='id identifier rubyid_shelf_name'>shelf_name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_json_array'>json_array</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_result_array'>result_array</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_result_array'>result_array</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>status</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_status'>status</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_result_array'>result_array</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>book_code</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_book_code'>book_code</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_result_array'>result_array</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>shelves</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_shelves'>shelves</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_result_array'>result_array</span><span class='lbracket'>[</span><span class='int'>3</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>shelf_name</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_shelf_name'>shelf_name</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_json_array'>json_array</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>result</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_result_array'>result_array</span>
  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_generate'>generate</span><span class='lparen'>(</span><span class='id identifier rubyid_json_array'>json_array</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="create-instance_method">
  
    - (<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>) <strong>create</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>借用ログを作る 結果一覧 0:返却 1:借用 -1:すべての図書が借用されていた場合 -2:図書が登録されていなかった場合
-3:グループに所属していなかった場合 -4:該当する図書が複数の本棚にあった場合 -5:該当する図書の本棚を登録する必要がある場合</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>:group_id</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Fixnum.html" title="Fixnum (class)">Fixnum</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>登録するグループID</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>:user_id</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Fixnum.html" title="Fixnum (class)">Fixnum</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>登録するユーザID</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>:book_code</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>登録する図書コード</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>結果と図書のタイトルを含むJSON形式の文字列</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/lend_log_controller.rb', line 59</span>

<span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
  <span class='id identifier rubyid_group_id'>group_id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:group_id</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_id</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_book_code'>book_code</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:book_code</span><span class='rbracket'>]</span>

  <span class='comment'># 該当する借用ログがあるかどうか
</span>  <span class='id identifier rubyid_is_lendlog'>is_lendlog</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='comment'># 該当する一時借用ログがあるかどうか
</span>  <span class='id identifier rubyid_is_temporary'>is_temporary</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='comment'># 一時借用ログが返却済みかどうか
</span>  <span class='id identifier rubyid_is_return'>is_return</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='comment'># 未借用の図書があるかどうか
</span>  <span class='id identifier rubyid_is_book'>is_book</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='comment'># 図書が登録されているかどうか
</span>  <span class='id identifier rubyid_is_book_register'>is_book_register</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='comment'># 借用したい図書のタイトル
</span>  <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># 該当する図書の一時借用ログの一覧
</span>  <span class='id identifier rubyid_temporary_logs'>temporary_logs</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

  <span class='comment'># 該当する借用ログ
</span>  <span class='id identifier rubyid_lend_log'>lend_log</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># 該当する一時借用ログ
</span>  <span class='id identifier rubyid_temp_first'>temp_first</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># 所属しているグループが無い場合
</span>  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_group_id'>group_id</span>
    <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json'>array_to_json</span><span class='lparen'>(</span><span class='op'>-</span><span class='int'>3</span><span class='comma'>,</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='rparen'>)</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'># タイトルの取得
</span>  <span class='id identifier rubyid_catalog'>catalog</span> <span class='op'>=</span>  <span class='const'>BookCatalog</span><span class='period'>.</span><span class='id identifier rubyid_find_by_book_code'>find_by_book_code</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_catalog'>catalog</span>
    <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='id identifier rubyid_catalog'>catalog</span><span class='period'>.</span><span class='id identifier rubyid_title'>title</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='id identifier rubyid_book_code'>book_code</span>
  <span class='kw'>end</span>

  <span class='comment'># グループ内のbook_codeを持つ図書一覧の取得
</span>  <span class='id identifier rubyid_books_group'>books_group</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find_all_by_book_code_and_group_id_and_delete_date'>find_all_by_book_code_and_group_id_and_delete_date</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>

  <span class='comment'># 図書がある場合
</span>  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_books_group'>books_group</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_is_book_register'>is_book_register</span> <span class='op'>=</span> <span class='kw'>true</span>

    <span class='id identifier rubyid_books_group'>books_group</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_book'>book</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span> <span class='op'>==</span> <span class='kw'>false</span>
        <span class='id identifier rubyid_is_book'>is_book</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># 一時借用ログがあるかどうか
</span>    <span class='id identifier rubyid_tmp'>tmp</span> <span class='op'>=</span> <span class='const'>TemporaryLendLog</span><span class='period'>.</span><span class='id identifier rubyid_find_all_by_book_code_and_group_id_and_user_id'>find_all_by_book_code_and_group_id_and_user_id</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_tmp'>tmp</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='id identifier rubyid_tmp'>tmp</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_log'>log</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_log'>log</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>!=</span> <span class='op'>-</span><span class='int'>1</span>
          <span class='id identifier rubyid_is_temporary'>is_temporary</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='id identifier rubyid_temporary_logs'>temporary_logs</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_log'>log</span><span class='rparen'>)</span>
          <span class='kw'>break</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_temporary_logs'>temporary_logs</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='id identifier rubyid_temp_first'>temp_first</span> <span class='op'>=</span> <span class='id identifier rubyid_temporary_logs'>temporary_logs</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
      <span class='comment'># 一時借用ログが返却済みかどうか
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_return_date'>return_date</span> <span class='op'>!=</span> <span class='kw'>nil</span>
        <span class='id identifier rubyid_is_return'>is_return</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># 借用ログがあるかどうか
</span>    <span class='id identifier rubyid_lend_log'>lend_log</span> <span class='op'>=</span> <span class='const'>LendLog</span><span class='period'>.</span><span class='id identifier rubyid_find_by_book_code_and_user_id_and_return_date'>find_by_book_code_and_user_id_and_return_date</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_lend_log'>lend_log</span>
      <span class='id identifier rubyid_is_lendlog'>is_lendlog</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>end</span>

    <span class='comment'># 図書が登録されていなかった場合
</span>  <span class='kw'>else</span>
    <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json'>array_to_json</span><span class='lparen'>(</span><span class='op'>-</span><span class='int'>2</span><span class='comma'>,</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='rparen'>)</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>temporary = </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lend log = </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>

  <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Base</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
    <span class='comment'># 借用ログに一致した場合
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_is_lendlog'>is_lendlog</span>

      <span class='id identifier rubyid_shelves'>shelves</span><span class='comma'>,</span> <span class='id identifier rubyid_shelves_name'>shelves_name</span> <span class='op'>=</span> <span class='id identifier rubyid_get_shelves'>get_shelves</span><span class='lparen'>(</span><span class='id identifier rubyid_group_id'>group_id</span><span class='rparen'>)</span>

      <span class='comment'># 一時借用ログがあるかどうか
</span>      <span class='id identifier rubyid_tmp_log'>tmp_log</span> <span class='op'>=</span> <span class='const'>TemporaryLendLog</span><span class='period'>.</span><span class='id identifier rubyid_find_all_by_book_code_and_group_id'>find_all_by_book_code_and_group_id</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_tmp_log'>tmp_log</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_log'>log</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_log'>log</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>!=</span> <span class='op'>-</span><span class='int'>1</span>
          <span class='id identifier rubyid_temp_first'>temp_first</span> <span class='op'>=</span> <span class='id identifier rubyid_log'>log</span>
          <span class='kw'>break</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>

      <span class='comment'># 返却処理
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_temp_first'>temp_first</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_return_date'>return_date</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y-%m-%d %H:%M:%S</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
        <span class='id identifier rubyid_book'>book</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_book_id'>book_id</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>

        <span class='comment'># 本棚登録する必要がある場合
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_temporary'>temporary</span>
          <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json_shelves'>array_to_json_shelves</span><span class='lparen'>(</span><span class='op'>-</span><span class='int'>5</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_shelves'>shelves</span><span class='comma'>,</span> <span class='id identifier rubyid_shelves_name'>shelves_name</span><span class='rparen'>)</span>
          <span class='kw'>return</span>
        <span class='kw'>end</span>

        <span class='comment'># 同じ図書コードで未登録本棚のもの
</span>        <span class='ivar'>@other_log</span> <span class='op'>=</span> <span class='kw'>nil</span>
        <span class='id identifier rubyid_books'>books</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find_all_by_book_code_and_group_id_and_delete_date'>find_all_by_book_code_and_group_id_and_delete_date</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_book'>book</span><span class='op'>|</span>
          <span class='ivar'>@other_log</span> <span class='op'>=</span> <span class='const'>LendLog</span><span class='period'>.</span><span class='id identifier rubyid_find_by_book_id_and_temporary'>find_by_book_id_and_temporary</span><span class='lparen'>(</span><span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='kw'>true</span><span class='rparen'>)</span>
          <span class='kw'>if</span> <span class='ivar'>@other_log</span>
            <span class='kw'>break</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>

        <span class='kw'>if</span> <span class='ivar'>@other_log</span>
          <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json_shelves'>array_to_json_shelves</span><span class='lparen'>(</span><span class='op'>-</span><span class='int'>5</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_shelves'>shelves</span><span class='comma'>,</span> <span class='id identifier rubyid_shelves_name'>shelves_name</span><span class='rparen'>)</span>
          <span class='kw'>return</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_shelf_name'>shelf_name</span> <span class='op'>=</span> <span class='const'>Shelf</span><span class='period'>.</span><span class='id identifier rubyid_find_by_shelf_id'>find_by_shelf_id</span><span class='lparen'>(</span><span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_book_id'>book_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_shelf_id'>shelf_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
        <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json_shelf_name'>array_to_json_shelf_name</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_shelf_name'>shelf_name</span><span class='rparen'>)</span>
        <span class='kw'>return</span>

        <span class='comment'># 一時借用ログがある場合
</span>      <span class='kw'>elsif</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>==</span> <span class='int'>0</span>
        <span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_return_date'>return_date</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y-%m-%d %H:%M:%S</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
        <span class='id identifier rubyid_book'>book</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_book_id'>book_id</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>

        <span class='comment'># その人以外が全員図書を所持している場合(図書の登録)
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_lenders'>lenders</span> <span class='op'>==</span> <span class='lparen'>(</span><span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_possessors'>possessors</span> <span class='op'>+</span> <span class='int'>1</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='op'>-</span><span class='int'>1</span>
          <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>

          <span class='id identifier rubyid_shelf_id'>shelf_id</span> <span class='op'>=</span> <span class='int'>0</span>
          <span class='id identifier rubyid_book'>book</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='symbol'>:book_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='symbol'>:group_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='symbol'>:shelf_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_shelf_id'>shelf_id</span><span class='comma'>,</span> <span class='symbol'>:state</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>  <span class='symbol'>:register_date</span> <span class='op'>=&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y-%m-%d %H:%M:%S</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
          <span class='const'>LendLog</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='symbol'>:book_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='symbol'>:lend_date</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_lend_date'>lend_date</span><span class='comma'>,</span> <span class='symbol'>:return_date</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_return_date'>return_date</span><span class='comma'>,</span> <span class='symbol'>:book_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='symbol'>:temporary</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_return_date'>return_date</span> <span class='op'>!=</span> <span class='kw'>nil</span>
            <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='kw'>false</span>
            <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
            <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json_shelves'>array_to_json_shelves</span><span class='lparen'>(</span><span class='op'>-</span><span class='int'>5</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_shelves'>shelves</span><span class='comma'>,</span> <span class='id identifier rubyid_shelves_name'>shelves_name</span><span class='rparen'>)</span>
            <span class='kw'>return</span>
          <span class='kw'>end</span>

        <span class='kw'>end</span>
        <span class='id identifier rubyid_shelf_name'>shelf_name</span> <span class='op'>=</span> <span class='const'>Shelf</span><span class='period'>.</span><span class='id identifier rubyid_find_by_shelf_id'>find_by_shelf_id</span><span class='lparen'>(</span><span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_book_id'>book_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_shelf_id'>shelf_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
        <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json_shelf_name'>array_to_json_shelf_name</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_shelf_name'>shelf_name</span><span class='rparen'>)</span>
        <span class='kw'>return</span>

        <span class='comment'># 図書を返却して借用ログを作成する場合
</span>      <span class='kw'>elsif</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>==</span> <span class='int'>1</span>
        <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='op'>-</span><span class='int'>1</span>
        <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>

        <span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_return_date'>return_date</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y-%m-%d %H:%M:%S</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>

        <span class='const'>LendLog</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='symbol'>:book_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_book_id'>book_id</span><span class='comma'>,</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='symbol'>:lend_date</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_lend_date'>lend_date</span><span class='comma'>,</span> <span class='symbol'>:return_date</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_return_date'>return_date</span><span class='comma'>,</span> <span class='symbol'>:book_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='rparen'>)</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_return_date'>return_date</span> <span class='op'>!=</span> <span class='kw'>nil</span>
          <span class='id identifier rubyid_book'>book</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find_by_book_code_and_group_id_and_state_and_delete_date'>find_by_book_code_and_group_id_and_state_and_delete_date</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='kw'>false</span>
          <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_shelf_name'>shelf_name</span> <span class='op'>=</span> <span class='const'>Shelf</span><span class='period'>.</span><span class='id identifier rubyid_find_by_shelf_id'>find_by_shelf_id</span><span class='lparen'>(</span><span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_lend_log'>lend_log</span><span class='period'>.</span><span class='id identifier rubyid_book_id'>book_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_shelf_id'>shelf_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
        <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json_shelf_name'>array_to_json_shelf_name</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_shelf_name'>shelf_name</span><span class='rparen'>)</span>
        <span class='kw'>return</span>
      <span class='kw'>end</span>

      <span class='comment'># 一時借用ログに一致する場合
</span>    <span class='kw'>elsif</span> <span class='id identifier rubyid_is_temporary'>is_temporary</span>

      <span class='comment'># 返却済みの場合
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_is_return'>is_return</span>

        <span class='comment'># 図書がある場合は通常借用
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_is_book'>is_book</span>
          <span class='id identifier rubyid_book'>book</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find_by_book_code_and_group_id_and_state_and_delete_date'>find_by_book_code_and_group_id_and_state_and_delete_date</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>

          <span class='const'>LendLog</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='symbol'>:book_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='symbol'>:lend_date</span> <span class='op'>=&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y-%m-%d %H:%M:%S</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='symbol'>:book_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json'>array_to_json</span><span class='lparen'>(</span><span class='int'>1</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='rparen'>)</span>
          <span class='kw'>return</span>

          <span class='comment'># 図書がない場合は一時借用ログを作成する場合へ
</span>        <span class='kw'>else</span>
          <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json'>array_to_json</span><span class='lparen'>(</span><span class='op'>-</span><span class='int'>1</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='rparen'>)</span>
          <span class='kw'>return</span>
        <span class='kw'>end</span>

        <span class='comment'># 返却の場合
</span>      <span class='kw'>elsif</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>==</span> <span class='int'>0</span>
        <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_return_date'>return_date</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y-%m-%d %H:%M:%S</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>

        <span class='kw'>if</span> <span class='id identifier rubyid_is_book'>is_book</span>
          <span class='id identifier rubyid_shelf_id'>shelf_id</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find_by_book_code_and_group_id_and_state_and_delete_date'>find_by_book_code_and_group_id_and_state_and_delete_date</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_shelf_id'>shelf_id</span>
          <span class='id identifier rubyid_book'>book</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='symbol'>:book_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='symbol'>:group_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='symbol'>:shelf_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_shelf_id'>shelf_id</span><span class='comma'>,</span> <span class='symbol'>:state</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>  <span class='symbol'>:register_date</span> <span class='op'>=&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y-%m-%d %H:%M:%S</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
          <span class='const'>LendLog</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='symbol'>:book_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='symbol'>:lend_date</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_lend_date'>lend_date</span><span class='comma'>,</span> <span class='symbol'>:return_date</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_temp_first'>temp_first</span><span class='period'>.</span><span class='id identifier rubyid_return_date'>return_date</span><span class='comma'>,</span> <span class='symbol'>:book_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='rparen'>)</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json'>array_to_json</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='rparen'>)</span>
        <span class='kw'>return</span>
      <span class='kw'>end</span>

      <span class='comment'># 一時借用ログを作る場合
</span>    <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_is_temporary'>is_temporary</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_is_book_register'>is_book_register</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_is_lendlog'>is_lendlog</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_is_book'>is_book</span>
      <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json'>array_to_json</span><span class='lparen'>(</span><span class='op'>-</span><span class='int'>1</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='rparen'>)</span>
      <span class='kw'>return</span>

      <span class='comment'># 借用処理
</span>    <span class='kw'>else</span>
      <span class='ivar'>@book</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_books'>books</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find_all_by_book_code_and_group_id_and_state_and_delete_date'>find_all_by_book_code_and_group_id_and_state_and_delete_date</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>&gt;</span> <span class='int'>1</span>
        <span class='id identifier rubyid_shelves'>shelves</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_shelves_name'>shelves_name</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_book'>book</span><span class='op'>|</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_shelf_id'>shelf_id</span> <span class='op'>!=</span> <span class='int'>0</span>
            <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_shelves'>shelves</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_shelf_id'>shelf_id</span><span class='rparen'>)</span>
              <span class='id identifier rubyid_shelves'>shelves</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_shelf_id'>shelf_id</span><span class='rparen'>)</span>
              <span class='id identifier rubyid_shelves_name'>shelves_name</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='const'>Shelf</span><span class='period'>.</span><span class='id identifier rubyid_find_by_shelf_id_and_group_id'>find_by_shelf_id_and_group_id</span><span class='lparen'>(</span><span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_shelf_id'>shelf_id</span><span class='comma'>,</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>

        <span class='kw'>if</span> <span class='id identifier rubyid_shelves'>shelves</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>&gt;</span> <span class='int'>1</span>
          <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json_shelves'>array_to_json_shelves</span><span class='lparen'>(</span><span class='op'>-</span><span class='int'>4</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='id identifier rubyid_shelves'>shelves</span><span class='comma'>,</span> <span class='id identifier rubyid_shelves_name'>shelves_name</span><span class='rparen'>)</span>
          <span class='kw'>return</span>
        <span class='kw'>else</span>
          <span class='ivar'>@book</span> <span class='op'>=</span> <span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='ivar'>@book</span> <span class='op'>=</span> <span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
      <span class='kw'>end</span>
      <span class='ivar'>@book</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='ivar'>@book</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>

      <span class='const'>LendLog</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='symbol'>:book_id</span> <span class='op'>=&gt;</span> <span class='ivar'>@book</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='symbol'>:lend_date</span> <span class='op'>=&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y-%m-%d %H:%M:%S</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='symbol'>:book_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json'>array_to_json</span><span class='lparen'>(</span><span class='int'>1</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='rparen'>)</span>
      <span class='kw'>return</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_shelves-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>get_shelves</strong>(group_id) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>本棚IDと本棚名の取得</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


401
402
403
404
405
406
407
408
409
410
411
412</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/lend_log_controller.rb', line 401</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_shelves'>get_shelves</span><span class='lparen'>(</span><span class='id identifier rubyid_group_id'>group_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_shelves'>shelves</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_shelves_name'>shelves_name</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_shelf'>shelf</span> <span class='op'>=</span> <span class='const'>Shelf</span><span class='period'>.</span><span class='id identifier rubyid_find_all_by_group_id'>find_all_by_group_id</span><span class='lparen'>(</span><span class='id identifier rubyid_group_id'>group_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_shelf'>shelf</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_sh'>sh</span><span class='op'>|</span>
    <span class='id identifier rubyid_shelves'>shelves</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_sh'>sh</span><span class='period'>.</span><span class='id identifier rubyid_shelf_id'>shelf_id</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_shelves_name'>shelves_name</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_sh'>sh</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_shelves'>shelves</span><span class='comma'>,</span> <span class='id identifier rubyid_shelves_name'>shelves_name</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="index-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>index</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>借用ログ一覧</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


6
7
8
9
10
11
12</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/lend_log_controller.rb', line 6</span>

<span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
  <span class='ivar'>@lend_logs</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_books'>books</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find_all_by_group_id_and_delete_date'>find_all_by_group_id_and_delete_date</span><span class='lparen'>(</span><span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:group_id</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_book'>book</span><span class='op'>|</span>
    <span class='ivar'>@lend_logs</span><span class='period'>.</span><span class='id identifier rubyid_concat'>concat</span><span class='lparen'>(</span><span class='const'>LendLog</span><span class='period'>.</span><span class='id identifier rubyid_find_all_by_book_id'>find_all_by_book_id</span><span class='lparen'>(</span><span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="push_not_possess-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>push_not_possess</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>図書を持っていない場合</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>book_code</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
    </li>
  
    <li>
      
        <span class='name'>group_id</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Fixnum.html" title="Fixnum (class)">Fixnum</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


385
386
387
388
389
390
391
392
393
394
395
396
397
398</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/lend_log_controller.rb', line 385</span>

<span class='kw'>def</span> <span class='id identifier rubyid_push_not_possess'>push_not_possess</span>
  <span class='id identifier rubyid_book_code'>book_code</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:book_code</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_group_id'>group_id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:group_id</span><span class='rbracket'>]</span>

  <span class='comment'># 一時借用ログの取得
</span>  <span class='id identifier rubyid_temporary_log'>temporary_log</span> <span class='op'>=</span> <span class='const'>TemporaryLendLog</span><span class='period'>.</span><span class='id identifier rubyid_find_by_book_code_and_group_id_and_status'>find_by_book_code_and_group_id_and_status</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>

  <span class='comment'># 一時借用ログがあった場合, 未所持者がいたことの状態を記録
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_temporary_log'>temporary_log</span>
    <span class='id identifier rubyid_temporary_log'>temporary_log</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='int'>1</span>
    <span class='id identifier rubyid_temporary_log'>temporary_log</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:nothing</span> <span class='op'>=&gt;</span> <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="push_possess-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>push_possess</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>図書を持っている場合</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>book_code</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
    </li>
  
    <li>
      
        <span class='name'>group_id</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Fixnum.html" title="Fixnum (class)">Fixnum</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/lend_log_controller.rb', line 352</span>

<span class='kw'>def</span> <span class='id identifier rubyid_push_possess'>push_possess</span>
  <span class='id identifier rubyid_book_code'>book_code</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:book_code</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_group_id'>group_id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:group_id</span><span class='rbracket'>]</span>

  <span class='comment'># 一時借用ログの取得
</span>  <span class='id identifier rubyid_temporary_log'>temporary_log</span> <span class='op'>=</span> <span class='const'>TemporaryLendLog</span><span class='period'>.</span><span class='id identifier rubyid_find_by_book_code_and_group_id_and_status'>find_by_book_code_and_group_id_and_status</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>

  <span class='comment'># 一時借用ログがあった場合
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_temporary_log'>temporary_log</span>
    <span class='id identifier rubyid_temporary_log'>temporary_log</span><span class='period'>.</span><span class='id identifier rubyid_possessors'>possessors</span> <span class='op'>+=</span> <span class='int'>1</span>

    <span class='comment'># 借用者数と所持者数が一緒の場合, その状態を記録しそのまま登録
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_temporary_log'>temporary_log</span><span class='period'>.</span><span class='id identifier rubyid_possessors'>possessors</span> <span class='op'>==</span> <span class='id identifier rubyid_temporary_log'>temporary_log</span><span class='period'>.</span><span class='id identifier rubyid_lenders'>lenders</span>
      <span class='id identifier rubyid_temporary_log'>temporary_log</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='op'>-</span><span class='int'>1</span>
      <span class='id identifier rubyid_temporary_log'>temporary_log</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>

      <span class='id identifier rubyid_shelf_id'>shelf_id</span> <span class='op'>=</span> <span class='int'>0</span>
      <span class='id identifier rubyid_book'>book</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='symbol'>:book_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='symbol'>:group_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='symbol'>:shelf_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_shelf_id'>shelf_id</span><span class='comma'>,</span> <span class='symbol'>:state</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>  <span class='symbol'>:register_date</span> <span class='op'>=&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y-%m-%d %H:%M:%S</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='comment'># 一時借用ログが借用中の場合
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_temporary_log'>temporary_log</span><span class='period'>.</span><span class='id identifier rubyid_return_date'>return_date</span> <span class='op'>==</span> <span class='kw'>nil</span>
        <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='kw'>true</span>
        <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
      <span class='kw'>end</span>
      <span class='const'>LendLog</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='symbol'>:book_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_temporary_log'>temporary_log</span><span class='period'>.</span><span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='symbol'>:lend_date</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_temporary_log'>temporary_log</span><span class='period'>.</span><span class='id identifier rubyid_lend_date'>lend_date</span><span class='comma'>,</span> <span class='symbol'>:return_date</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_temporary_log'>temporary_log</span><span class='period'>.</span><span class='id identifier rubyid_return_date'>return_date</span><span class='comma'>,</span> <span class='symbol'>:book_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='symbol'>:temporary</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

  <span class='kw'>end</span>
  <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:nothing</span> <span class='op'>=&gt;</span> <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="select_shelf_lend-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>select_shelf_lend</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>本棚を選択して借用する場合</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>qr</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Fixnum.html" title="Fixnum (class)">Fixnum</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>本棚ID</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>book_code</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>図書コード</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>group_id</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Fixnum.html" title="Fixnum (class)">Fixnum</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>グループID</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>user_id</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Fixnum.html" title="Fixnum (class)">Fixnum</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>ユーザID</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/lend_log_controller.rb', line 332</span>

<span class='kw'>def</span> <span class='id identifier rubyid_select_shelf_lend'>select_shelf_lend</span>
  <span class='id identifier rubyid_shelf_id'>shelf_id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:qr</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_book_code'>book_code</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:book_code</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_group_id'>group_id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:group_id</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_id</span><span class='rbracket'>]</span>

  <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Base</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_book'>book</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find_by_book_code_and_group_id_and_shelf_id_and_state_and_delete_date'>find_by_book_code_and_group_id_and_shelf_id_and_state_and_delete_date</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='id identifier rubyid_shelf_id'>shelf_id</span><span class='comma'>,</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
    <span class='const'>LendLog</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='symbol'>:book_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='symbol'>:book_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='symbol'>:lend_date</span> <span class='op'>=&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y-%m-%d %H:%M:%S</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='const'>BookCatalog</span><span class='period'>.</span><span class='id identifier rubyid_find_by_book_code'>find_by_book_code</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_title'>title</span>
    <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json'>array_to_json</span><span class='lparen'>(</span><span class='int'>1</span><span class='comma'>,</span> <span class='id identifier rubyid_title'>title</span><span class='rparen'>)</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="temporary_create-instance_method">
  
    - (<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>) <strong>temporary_create</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>一時借用ログを作る</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>:group_id</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Fixnum.html" title="Fixnum (class)">Fixnum</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>登録するグループID</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>:user_id</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Fixnum.html" title="Fixnum (class)">Fixnum</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>登録するユーザID</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>:book_code</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>登録する図書コード</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>結果と図書のタイトルを含むJSON形式の文字列</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/lend_log_controller.rb', line 19</span>

<span class='kw'>def</span> <span class='id identifier rubyid_temporary_create'>temporary_create</span>
  <span class='id identifier rubyid_group_id'>group_id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:group_id</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_id</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_book_code'>book_code</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:book_code</span><span class='rbracket'>]</span>

  <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Base</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
    <span class='comment'># 借用者の数を取得
</span>    <span class='id identifier rubyid_lenders'>lenders</span> <span class='op'>=</span> <span class='int'>0</span>
    <span class='id identifier rubyid_logs'>logs</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_books'>books</span> <span class='op'>=</span> <span class='const'>Book</span><span class='period'>.</span><span class='id identifier rubyid_find_all_by_book_code_and_group_id_and_delete_date'>find_all_by_book_code_and_group_id_and_delete_date</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_books'>books</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_book'>book</span><span class='op'>|</span>
      <span class='id identifier rubyid_logs'>logs</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='const'>LendLog</span><span class='period'>.</span><span class='id identifier rubyid_find_all_by_book_id_and_return_date'>find_all_by_book_id_and_return_date</span><span class='lparen'>(</span><span class='id identifier rubyid_book'>book</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_lenders'>lenders</span> <span class='op'>=</span> <span class='id identifier rubyid_logs'>logs</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>

    <span class='comment'># 一時借用ログを作成
</span>    <span class='comment'># status 一覧
</span>    <span class='comment'># 0:一時借用ログ作成時
</span>    <span class='comment'># 1:誰かがNoを押した場合
</span>    <span class='comment'># 2:全員がYesを押した場合
</span>    <span class='comment'># -1:借用ログを作成済み
</span>    <span class='id identifier rubyid_temporary_lend_log'>temporary_lend_log</span> <span class='op'>=</span> <span class='const'>TemporaryLendLog</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='symbol'>:book_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_book_code'>book_code</span><span class='comma'>,</span> <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='symbol'>:group_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_group_id'>group_id</span><span class='comma'>,</span> <span class='symbol'>:lend_date</span> <span class='op'>=&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y-%m-%d %H:%M:%S</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='symbol'>:status</span> <span class='op'>=&gt;</span> <span class='int'>0</span><span class='comma'>,</span> <span class='symbol'>:lenders</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_lenders'>lenders</span><span class='comma'>,</span> <span class='symbol'>:possessors</span> <span class='op'>=&gt;</span> <span class='int'>0</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_array_to_json'>array_to_json</span><span class='lparen'>(</span><span class='int'>1</span><span class='comma'>,</span> <span class='const'>BookCatalog</span><span class='period'>.</span><span class='id identifier rubyid_find_by_book_code'>find_by_book_code</span><span class='lparen'>(</span><span class='id identifier rubyid_book_code'>book_code</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_title'>title</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Wed Nov 19 10:17:25 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.4 (ruby-1.9.3).
</div>

  </body>
</html>