<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Mutex
  
    &mdash; Documentation by YARD 0.8.7.4
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!Mutex.html";
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (M)</a> &raquo;
    
    
    <span class="title">Mutex</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Mutex
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></span>
      
        <ul class="fullTree">
          <li><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></li>
          
            <li class="next">Mutex</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">thread.c<span class="defines">,<br />
  thread.c</span>
</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Mutex implements a simple semaphore that can be used to coordinate access
to shared data from multiple concurrent threads.</p>

<p>Example:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">'thread'</span>
<span class="ruby-identifier">semaphore</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>

<span class="ruby-identifier">a</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
  <span class="ruby-identifier">semaphore</span>.<span class="ruby-identifier">synchronize</span> {
    <span class="ruby-comment"># access shared resource</span>
  }
}

<span class="ruby-identifier">b</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
  <span class="ruby-identifier">semaphore</span>.<span class="ruby-identifier">synchronize</span> {
    <span class="ruby-comment"># access shared resource</span>
  }
}
</pre>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#new (instance method)">- (Object) <strong>new</strong> </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Creates a new Mutex.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#lock-instance_method" title="#lock (instance method)">- (self) <strong>lock</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Attempts to grab the lock and waits if it isn’t available.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#locked%3F-instance_method" title="#locked? (instance method)">- (Boolean) <strong>locked?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns <code>true</code> if this lock is currently held by some thread.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#sleep-instance_method" title="#sleep (instance method)">- (Numeric) <strong>sleep</strong>(timeout = nil) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Releases the lock and sleeps <code>timeout</code> seconds if it is given
and non-nil or forever.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#try_lock-instance_method" title="#try_lock (instance method)">- (Boolean) <strong>try_lock</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Attempts to obtain the lock and returns immediately.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unlock-instance_method" title="#unlock (instance method)">- (self) <strong>unlock</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Releases the lock.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="Object.html" title="Object (class)">Object</a></span></tt>) <strong>new</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Creates a new Mutex</p>


  </div>
</div>
<div class="tags">
  
  


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


3433
3434
3435
3436
3437</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'thread.c', line 3433</span>

static VALUE
mutex_initialize(VALUE self)
{
    return self;
}</pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="lock-instance_method">
  
    - (<tt>self</tt>) <strong>lock</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Attempts to grab the lock and waits if it isn’t available. Raises
<code>ThreadError</code> if <code>mutex</code> was locked by the current
thread.</p>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>self</tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


3561
3562
3563
3564
3565
3566
3567
3568
3569
3570
3571
3572
3573
3574
3575
3576
3577
3578
3579
3580
3581
3582
3583
3584
3585
3586
3587
3588
3589
3590
3591
3592
3593
3594
3595
3596
3597
3598
3599
3600
3601
3602
3603
3604
3605
3606
3607
3608
3609
3610
3611
3612
3613
3614
3615
3616
3617
3618
3619
3620
3621
3622
3623
3624</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'thread.c', line 3561</span>

VALUE
rb_mutex_lock(VALUE self)
{

    if (rb_mutex_trylock(self) == Qfalse) {
	rb_mutex_t *mutex;
	rb_thread_t *th = GET_THREAD();
	GetMutexPtr(self, mutex);

	if (mutex-&gt;th == GET_THREAD()) {
	    rb_raise(rb_eThreadError, &quot;deadlock; recursive locking&quot;);
	}

	while (mutex-&gt;th != th) {
	    int interrupted;
	    enum rb_thread_status prev_status = th-&gt;status;
	    int timeout_ms = 0;
	    struct rb_unblock_callback oldubf;

	    set_unblock_function(th, lock_interrupt, mutex, &amp;oldubf);
	    th-&gt;status = THREAD_STOPPED_FOREVER;
	    th-&gt;locking_mutex = self;

	    native_mutex_lock(&amp;mutex-&gt;lock);
	    th-&gt;vm-&gt;sleeper++;
	    /*
	     * Carefully! while some contended threads are in lock_func(),
	     * vm-&gt;sleepr is unstable value. we have to avoid both deadlock
	     * and busy loop.
	     */
	    if ((vm_living_thread_num(th-&gt;vm) == th-&gt;vm-&gt;sleeper) &amp;&amp;
		!patrol_thread) {
		timeout_ms = 100;
		patrol_thread = th;
	    }

	    GVL_UNLOCK_BEGIN();
	    interrupted = lock_func(th, mutex, timeout_ms);
	    native_mutex_unlock(&amp;mutex-&gt;lock);
	    GVL_UNLOCK_END();

	    if (patrol_thread == th)
		patrol_thread = NULL;

	    reset_unblock_function(th, &amp;oldubf);

	    th-&gt;locking_mutex = Qfalse;
	    if (mutex-&gt;th &amp;&amp; interrupted == 2) {
		rb_check_deadlock(th-&gt;vm);
	    }
	    if (th-&gt;status == THREAD_STOPPED_FOREVER) {
		th-&gt;status = prev_status;
	    }
	    th-&gt;vm-&gt;sleeper--;

	    if (mutex-&gt;th == th) mutex_locked(th, self);

	    if (interrupted) {
		RUBY_VM_CHECK_INTS();
	    }
	}
    }
    return self;
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="locked?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>locked?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns <code>true</code> if this lock is currently held by some thread.</p>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


3451
3452
3453
3454
3455
3456
3457</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'thread.c', line 3451</span>

VALUE
rb_mutex_locked_p(VALUE self)
{
    rb_mutex_t *mutex;
    GetMutexPtr(self, mutex);
    return mutex-&gt;th ? Qtrue : Qfalse;
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="sleep-instance_method">
  
    - (<tt><span class='object_link'><a href="Numeric.html" title="Numeric (class)">Numeric</a></span></tt>) <strong>sleep</strong>(timeout = nil) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Releases the lock and sleeps <code>timeout</code> seconds if it is given
and non-nil or forever.  Raises <code>ThreadError</code> if
<code>mutex</code> wasn’t locked by the current thread.</p>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Numeric.html" title="Numeric (class)">Numeric</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


3747
3748
3749
3750
3751
3752
3753
3754</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'thread.c', line 3747</span>

static VALUE
mutex_sleep(int argc, VALUE *argv, VALUE self)
{
    VALUE timeout;

    rb_scan_args(argc, argv, &quot;01&quot;, &amp;timeout);
    return rb_mutex_sleep(self, timeout);
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="try_lock-instance_method">
  
    - (<tt>Boolean</tt>) <strong>try_lock</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Attempts to obtain the lock and returns immediately. Returns
<code>true</code> if the lock was granted.</p>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


3478
3479
3480
3481
3482
3483
3484
3485
3486
3487
3488
3489
3490
3491
3492
3493
3494
3495</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'thread.c', line 3478</span>

VALUE
rb_mutex_trylock(VALUE self)
{
    rb_mutex_t *mutex;
    VALUE locked = Qfalse;
    GetMutexPtr(self, mutex);

    native_mutex_lock(&amp;mutex-&gt;lock);
    if (mutex-&gt;th == 0) {
	mutex-&gt;th = GET_THREAD();
	locked = Qtrue;

	mutex_locked(GET_THREAD(), self);
    }
    native_mutex_unlock(&amp;mutex-&gt;lock);

    return locked;
}</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unlock-instance_method">
  
    - (<tt>self</tt>) <strong>unlock</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Releases the lock. Raises <code>ThreadError</code> if <code>mutex</code>
wasn’t locked by the current thread.</p>


  </div>
</div>
<div class="tags">
  
  <div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>self</tt>)</span>
      
      
      
    </li>
  
</ul>

</div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


3677
3678
3679
3680
3681
3682
3683
3684
3685
3686
3687
3688</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'thread.c', line 3677</span>

VALUE
rb_mutex_unlock(VALUE self)
{
    const char *err;
    rb_mutex_t *mutex;
    GetMutexPtr(self, mutex);

    err = rb_mutex_unlock_th(mutex, GET_THREAD());
    if (err) rb_raise(rb_eThreadError, &quot;%s&quot;, err);

    return self;
}</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Wed Nov 19 10:16:46 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.4 (ruby-1.9.3).
</div>

  </body>
</html>